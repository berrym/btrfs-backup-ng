# Tier 2 Integration Tests - Real btrfs operations
# These tests require root privileges and btrfs support
# Runs on manual trigger or weekly schedule

name: Integration Tests (Tier 2)

on:
  # Manual trigger with optional debug mode
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug output"
        required: false
        default: false
        type: boolean

  # Weekly run on Sundays at 2 AM UTC
  schedule:
    - cron: "0 2 * * 0"

  # Also run on PRs that modify tier2 tests or core btrfs code
  pull_request:
    branches: [master, main]
    paths:
      - "tests/integration/tier2/**"
      - "src/btrfs_backup_ng/endpoint/**"
      - "src/btrfs_backup_ng/core/**"
      - "src/btrfs_backup_ng/__util__.py"

jobs:
  tier2-tests:
    name: Tier 2 btrfs Integration Tests
    runs-on: ubuntu-latest

    # Run in a privileged container with btrfs support
    container:
      image: fedora:latest
      options: --privileged

    steps:
      - name: Install system dependencies
        run: |
          dnf install -y \
            btrfs-progs \
            python3 \
            python3-pip \
            git \
            kmod \
            util-linux

      - name: Check btrfs support
        run: |
          echo "=== Checking btrfs support ==="
          modprobe btrfs || echo "btrfs module load failed (may be built-in)"
          btrfs --version
          mkfs.btrfs --version
          echo "=== btrfs support OK ==="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -e ".[test]"

      - name: Run Tier 2 integration tests
        run: |
          pytest tests/integration/tier2/ -v -m tier2 --tb=long ${{ inputs.debug == 'true' && '-s' || '' }}

      - name: Run Tier 2 tests with coverage
        if: success()
        run: |
          pip install pytest-cov
          pytest tests/integration/tier2/ -v -m tier2 \
            --cov=src/btrfs_backup_ng \
            --cov-report=xml:coverage-tier2.xml \
            --cov-report=term-missing \
            --cov-fail-under=0

      - name: Upload Tier 2 coverage
        if: success()
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage-tier2.xml
          flags: tier2-integration
          name: codecov-tier2
          fail_ci_if_error: false

  # Summary job for branch protection rules
  tier2-complete:
    name: Tier 2 Tests Complete
    runs-on: ubuntu-latest
    needs: tier2-tests
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Tier 2 test job result: ${{ needs.tier2-tests.result }}"
          if [ "${{ needs.tier2-tests.result }}" == "success" ]; then
            echo "✅ Tier 2 integration tests passed"
            exit 0
          elif [ "${{ needs.tier2-tests.result }}" == "skipped" ]; then
            echo "⏭️ Tier 2 tests were skipped"
            exit 0
          else
            echo "❌ Tier 2 integration tests failed"
            exit 1
          fi
